---
title: "JQT paper with 200 drivers"
author: "Miao Cai <miao.cai@slu.edu>"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```





```{r data processing, eval = F}
library(dplyr)

# load data and format the date and time
dat0 = readr::read_csv("2015-5-COLORED COLS.csv") %>% filter(!is.na(driver1)) 
dat = dat0 %>% 
  mutate(begDate = lubridate::mdy_hm(begDate), 
         EndTime = lubridate::mdy_hm(EndTime)) %>% 
  arrange(driver1, begDate)



# dichotomize the events
dat$event_i = 0
dat$event_i[dat$cnum > 0] = 1



# the function to segment trips
segment_1 = function(threshold_hour, time_diff){
  r1 = time_diff >= threshold_hour
  r2 = rle(r1)
  r2$values[r2$values == FALSE] = 0
  r2$values = cumsum(r2$values)
  return(inverse.rle(r2))
}
# cumulative driving time
t = dat %>% group_by(driver1) %>% 
  mutate(time_diff = difftime(begDate, lag(EndTime, default = 0), units = "hours"),
         time_diff = ifelse(row_number() == 1, 0, time_diff),
         shift = segment_1(8, time_diff),
         driver_shift_id = paste(driver1, shift, sep = "_")) %>% 
  ungroup()



save(t, file = "t.Rdata")
```


```{r Bayesianlogit}
load("t.Rdata")

library(rstan)
library(rstanarm)
library(shinystan)
options(mc.cores=parallel::detectCores())


t1 = t[t$driver_num <= 10,]

codestan = '
data {
  int<lower=0> n; //total # of obs
  int<lower=0> k;

  int<lower=0> driver_num[n]; //driver id
  int<lower=0> event_i[n]; //binary outcome
  real<lower=0> drivetime_cum[n]; //cumulative time of driving
  int<lower=0> precip_bi[n]; //precipitation
}
parameters{
  real beta0[k];
  real beta1[k];
  real beta2;
  real mu0;
  real mu1;
  real<lower=0> sigma0;
  real<lower=0> sigma1;
}
model{
  for(i in 1:n){
     event_i[i] ~ bernoulli_logit(beta0[driver_num[i]] + beta1[driver_num[i]]*drivetime_cum[i] + beta2*precip_bi[i]); 
  }
  //PRIORS
  beta2 ~ normal(0, 10);
  for(j in 1:k){
  beta0[j] ~ normal(mu0, sigma0);
  beta1[j] ~ normal(mu1, sigma1);
  }
  //HYPERPRIORS
  mu0 ~ normal(0, 10);
  mu1 ~ normal(0, 10);
  sigma0 ~ gamma(1, 1);
  sigma1 ~ gamma(1, 1);
}
'

datstan = list(n = nrow(t1),
               k = max(t1$driver_num),
               driver_num = t1$driver_num,
               event_i = t1$event_i,
               drivetime_cum = t1$drivetime_cum,
               precip_bi = t1$precip_bi)

hfitlogit20000 <- stan(model_code=codestan, model_name="hospitals1", data=datstan, iter=3000,warmup = 1000, chains=3, control = list(adapt_delta = 0.9))

#save(hfitlogit20000, file = "hfitlogit20000.Rdata")


shinystan::launch_shinystan(hfitlogit20000)
```










## Bayesian Hierarchical Poisson Regression

```{r BayesianPois}
load("t.Rdata")

library(rstan)
library(rstanarm)
library(shinystan)
options(mc.cores=parallel::detectCores())

t1 = t[1:20000,]

poistan = '
data {
  int<lower=0> n; //total # of obs
  int<lower=0> k;

  int<lower=0> driver_num[n]; //driver id
  int<lower=0> cnum[n]; //count outcome
  real<lower=0> drivetime_cum[n]; //cumulative time of driving
  real<lower=0> travelTime[n];
  int<lower=0> precip_bi[n]; //precipitation
}
parameters{
  real beta0[k];
  real beta1[k];
  real beta2;
  real mu0;
  real mu1;
  real<lower=0> sigma0;
  real<lower=0> sigma1;
}
model{
  for(i in 1:n){
    cnum[i] ~ poisson( travelTime[i] * exp(beta0[driver_num[i]] + beta1[driver_num[i]]*drivetime_cum[i] + beta2*precip_bi[i]) );
  }
  //PRIORS
  beta2 ~ normal(0, 10);
  for(j in 1:k){
  beta0[j] ~ normal(mu0, sigma0);
  beta1[j] ~ normal(mu1, sigma1);
  }
  //HYPERPRIORS
  mu0 ~ normal(0, 10);
  mu1 ~ normal(0, 10);
  sigma0 ~ gamma(1, 1);
  sigma1 ~ gamma(1, 1);
}
'

datstan = list(n = nrow(t1),
               k = max(t1$driver_num),
               travelTime = t1$travelTime,
               driver_num = t1$driver_num,
               cnum = t1$cnum,
               drivetime_cum = t1$drivetime_cum,
               precip_bi = t1$precip_bi)

hfitpois20000 <- stan(model_code=poistan, model_name="Poisstan", data=datstan, iter=5000,warmup = 1000, chains=3, control = list(adapt_delta = 0.95))


save(hfitpois20000, file = "hfitpois20000.Rdata")

shinystan::launch_shinystan(hfitpois20000)
```










# DarkSky API

The DarkSky API provides the following meteoreological variables:

- Apparent (feels-like) temperature
- Atmospheric pressure
- Cloud cover
- Dew point
- Humidity
- Liquid precipitation rate
- Moon phase
- Nearest storm distance
- Nearest storm direction
- Ozone
- Precipitation type
- Snowfall
- Sun rise/set
- Temperature
- Text summaries
- UV index
- Wind gust
- Wind speed
- Wind direction

```{r testsample}
# sample place and time in St. Louis with raining
sampletime = force_tz(ymd_hms("2016-07-20 10:05:00 UTC"), "US/Central")#"US/Eastern"
we = get_forecast_for("38.6270025", "-90.1994042", sampletime)
```


```{r darksky}
load("t.Rdata")
t = t[,-c(41:61)] # get rid of previous weather variables

library(darksky)
library(tidyverse)
library(lubridate)

Sys.setenv(DARKSKY_API_KEY = "9f219edf4689a0f26a83aa4d9a46f25a")

# check the number of trips for each driver
t %>% group_by(driver1) %>% count() %>% arrange(desc(n))
# check the number of critical events for each driver
sumcnum = t %>% group_by(driver1) %>% summarise(sum_cnum = sum(cnum)) %>% arrange(desc(sum_cnum)) %>% print(n = 50)

# select most representative 1000 obs
t1 = t %>% filter(driver_num <= 300)
t1$begDate = lubridate::force_tz(t1$begDate, "US/Central") # set timezone


add_var = function(dat){
  dat[,c("time", 'summary', 'icon', 'precipIntensity', 'precipProbability', 'temperature', 'apparentTemperature', 'dewPoint', 'humidity', 'pressure', 'windSpeed', 'windGust', 'windBearing', 'cloudCover', 'visibility', 'sunriseTime', 'sunsetTime', 'moonPhase')] = NA
  return(dat)
}

t1 = add_var(t1)

pb <- utils::txtProgressBar(min = 20000, max = nrow(t1), style = 3)
start = Sys.time()
for(i in 20000:nrow(t1)){
  tempvar = get_forecast_for(t1$fromlat[i], t1$fromLon[i], t1$begDate[i])
  t1$time[i] = ifelse(is.null(tempvar[[3]]$time), NA, tempvar[[3]]$time)
  t1$summary[i] = ifelse(is.null(tempvar[[3]]$summary), NA, tempvar[[3]]$summary)
  t1$icon[i] = ifelse(is.null(tempvar[[3]]$icon), NA, tempvar[[3]]$icon)
  t1$precipIntensity[i] = ifelse(is.null(tempvar[[3]]$precipIntensity), NA, tempvar[[3]]$precipIntensity)
  t1$precipProbability[i] = ifelse(is.null(tempvar[[3]]$precipProbability), NA, tempvar[[3]]$precipProbability)
  t1$temperature[i] = ifelse(is.null(tempvar[[3]]$temperature), NA, tempvar[[3]]$temperature)
  t1$apparentTemperature[i] = ifelse(is.null(tempvar[[3]]$apparentTemperature), NA, tempvar[[3]]$apparentTemperature)
  t1$dewPoint[i] = ifelse(is.null(tempvar[[3]]$dewPoint), NA, tempvar[[3]]$dewPoint)
  t1$humidity[i] = ifelse(is.null(tempvar[[3]]$humidity), NA, tempvar[[3]]$humidity)
  t1$pressure[i] = ifelse(is.null(tempvar[[3]]$pressure), NA, tempvar[[3]]$pressure)
  t1$windSpeed[i] = ifelse(is.null(tempvar[[3]]$windSpeed), NA, tempvar[[3]]$windSpeed)
  t1$windGust[i] = ifelse(is.null(tempvar[[3]]$windGust), NA, tempvar[[3]]$windGust)
  t1$windBearing[i] = ifelse(is.null(tempvar[[3]]$windBearing), NA, tempvar[[3]]$windBearing)
  t1$cloudCover[i] = ifelse(is.null(tempvar[[3]]$cloudCover), NA, tempvar[[3]]$cloudCover)
  t1$visibility[i] = ifelse(is.null(tempvar[[3]]$visibility), NA, tempvar[[3]]$visibility)
  
  t1$sunriseTime[i] = ifelse(is.null(tempvar[[2]]$sunriseTime), NA, tempvar[[2]]$sunriseTime)
  t1$sunsetTime[i] = ifelse(is.null(tempvar[[2]]$sunsetTime), NA, tempvar[[2]]$sunsetTime)
  t1$moonPhase[i] = ifelse(is.null(tempvar[[2]]$visibility), NA, tempvar[[2]]$moonPhase)

  utils::setTxtProgressBar(pb, i)
}
Sys.time() - start

t1$sunriseTime = as.POSIXct(t1$sunriseTime, origin = "1970-01-01")
t1$sunsetTime = as.POSIXct(t1$sunsetTime, origin = "1970-01-01")
t1$visibility = zoo::na.locf(t1$visibility, na.rm = F)
t1$visibility[1] = t1$visibility[2] # the first value is NA, replace it with the 2nd value
t1$precipIntensity = zoo::na.locf(t1$precipIntensity)
t1$precipProbability = zoo::na.locf(t1$precipProbability)

weather2w = t1

save(weather2w, file = "weather2w.Rdata")
```


```{r weather CE}
load("weather2w.Rdata")

require(tidyr)
require(tidyverse)
require(lubridate)

CE_tripmax = max(weather2w$cnum)

CE_DATIME = weather2w %>% 
  mutate(trip_id = 1:nrow(.)) %>% 
  select(trip_id, DATIME) %>% 
  separate(DATIME, sep = ";", into = paste0("CE_datime", 1:CE_tripmax)) %>%  
  gather(key = Datime_NO, value = time_of_CE, -trip_id, na.rm = T) %>% 
  arrange(trip_id, Datime_NO) %>% 
  mutate(time_of_CE1 = ymd_hms(time_of_CE),
         time_of_CE2 = mdy_hm(time_of_CE),
         time_of_CE = coalesce(time_of_CE1, time_of_CE2),
         time_of_CE = lubridate::force_tz(time_of_CE, "US/Central")) %>% 
  select(-c(time_of_CE1, time_of_CE2))

CE_LAT = weather2w %>% 
  mutate(trip_id = 1:nrow(.)) %>% 
  select(trip_id, LAT) %>% 
  separate(LAT, sep = ";", into = paste0("CE_lat", 1:CE_tripmax)) %>%  
  gather(key = Lat_NO, value = CE_lat, -trip_id, na.rm = T) %>% 
  arrange(trip_id, Lat_NO) 

CE_LON = weather2w %>% 
  mutate(trip_id = 1:nrow(.)) %>% 
  select(trip_id, LON) %>% 
  separate(LON, sep = ";", into = paste0("CE_lon", 1:CE_tripmax)) %>%  
  gather(key = Lon_NO, value = CE_lon, -trip_id, na.rm = T) %>% 
  arrange(trip_id, Lon_NO) 

CE_2weather = bind_cols(CE_DATIME, CE_LAT, CE_LON) %>% 
  select(-c(trip_id1, trip_id2))

library(darksky)
Sys.setenv(DARKSKY_API_KEY = "9f219edf4689a0f26a83aa4d9a46f25a")


add_var = function(dat){
  dat[,c("time", 'summary', 'icon', 'precipIntensity', 'precipProbability', 'temperature', 'apparentTemperature', 'dewPoint', 'humidity', 'pressure', 'windSpeed', 'windGust', 'windBearing', 'cloudCover', 'visibility', 'sunriseTime', 'sunsetTime', 'moonPhase')] = NA
  #dat$sunriseTime = as.Date(dat$sunriseTime, origin = "1970-01-01")
  #dat$sunsetTime = as.Date(dat$sunsetTime, origin = "1970-01-01")
  return(dat)
}

CE_2weather = add_var(CE_2weather)


pb <- utils::txtProgressBar(min = 460, max = nrow(CE_2weather), style = 3)
start = Sys.time()
for(i in 460:nrow(CE_2weather)){
  tryCatch({
    tempvar = get_forecast_for(CE_2weather$CE_lat[i], CE_2weather$CE_lon[i], CE_2weather$time_of_CE[i])
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
  CE_2weather$time[i] = ifelse(is.null(tempvar[[3]]$time), NA, tempvar[[3]]$time)
  CE_2weather$summary[i] = ifelse(is.null(tempvar[[3]]$summary), NA, tempvar[[3]]$summary)
  CE_2weather$icon[i] = ifelse(is.null(tempvar[[3]]$icon), NA, tempvar[[3]]$icon)
  CE_2weather$precipIntensity[i] = ifelse(is.null(tempvar[[3]]$precipIntensity), NA, tempvar[[3]]$precipIntensity)
  CE_2weather$precipProbability[i] = ifelse(is.null(tempvar[[3]]$precipProbability), NA, tempvar[[3]]$precipProbability)
  CE_2weather$temperature[i] = ifelse(is.null(tempvar[[3]]$temperature), NA, tempvar[[3]]$temperature)
  CE_2weather$apparentTemperature[i] = ifelse(is.null(tempvar[[3]]$apparentTemperature), NA, tempvar[[3]]$apparentTemperature)
  CE_2weather$dewPoint[i] = ifelse(is.null(tempvar[[3]]$dewPoint), NA, tempvar[[3]]$dewPoint)
  CE_2weather$humidity[i] = ifelse(is.null(tempvar[[3]]$humidity), NA, tempvar[[3]]$humidity)
  CE_2weather$pressure[i] = ifelse(is.null(tempvar[[3]]$pressure), NA, tempvar[[3]]$pressure)
  CE_2weather$windSpeed[i] = ifelse(is.null(tempvar[[3]]$windSpeed), NA, tempvar[[3]]$windSpeed)
  CE_2weather$windGust[i] = ifelse(is.null(tempvar[[3]]$windGust), NA, tempvar[[3]]$windGust)
  CE_2weather$windBearing[i] = ifelse(is.null(tempvar[[3]]$windBearing), NA, tempvar[[3]]$windBearing)
  CE_2weather$cloudCover[i] = ifelse(is.null(tempvar[[3]]$cloudCover), NA, tempvar[[3]]$cloudCover)
  CE_2weather$visibility[i] = ifelse(is.null(tempvar[[3]]$visibility), NA, tempvar[[3]]$visibility)
  
  CE_2weather$sunriseTime[i] = tempvar[[2]]$sunriseTime
  CE_2weather$sunsetTime[i] = tempvar[[2]]$sunsetTime
  CE_2weather$moonPhase[i] = ifelse(is.null(tempvar[[2]]$visibility), NA, tempvar[[2]]$moonPhase)

  utils::setTxtProgressBar(pb, i)
}
Sys.time() - start

CE_2weather$sunriseTime = as.POSIXct(CE_2weather$sunriseTime, origin = "1970-01-01")
CE_2weather$sunsetTime = as.POSIXct(CE_2weather$sunsetTime, origin = "1970-01-01")
CE_2weather$visibility = zoo::na.locf(CE_2weather$visibility, na.rm = F)
CE_2weather$visibility[1] = CE_2weather$visibility[2] # the first value is NA, replace it with the 2nd value
CE_2weather$precipIntensity = zoo::na.locf(CE_2weather$precipIntensity)
CE_2weather$precipProbability = zoo::na.locf(CE_2weather$precipProbability)
```



```{r driver_character}
load("weather2w.Rdata")
require(dplyr)

# Driver characteristics
alpha = readr::read_csv("ALL_DRIVERS_DATA2016-09-30 10-53-42.csv") %>% filter(!is.na(BIRTHDATE))
empid = readr::read_csv("ALPHA_TO_EMPLID2016-10-21 14-00-24.csv") %>% mutate(ALPHA = tolower(ALPHA))

driver_t = inner_join(empid, alpha, by = "EMPLID")
driver_t = driver_t[!duplicated(driver_t$ALPHA),]

w2wdriver = left_join(weather2w, driver_t, by = c("driver1" = "ALPHA")) 
w2wdriver$Age = 2015 - lubridate::year(w2wdriver$BIRTHDATE)

save(w2wdriver, file = "w2wdriver.Rdata")
```



```{r Bayesianlogit1}
load("w2wdriver.Rdata")

w2wdriver = w2wdriver[!is.na(w2wdriver$Age),]

w1000 = w2wdriver

w1000$JBI00 = 0 # DCS00 as reference
w1000$JBI00[w1000$BUSINESS_UNIT == "JBI00"] = 1
w1000$VAN00 = 0
w1000$VAN00[w1000$BUSINESS_UNIT == "VAN00"] = 1 # DCS00 as reference

w1000$driver_num = as.integer(factor(w1000$driver_num)) # reorder driver number
w1000$visibility[is.na(w1000$visibility)] = mean(w1000$visibility, na.rm = T)

library(rstan)
library(rstanarm)
library(shinystan)
options(mc.cores=parallel::detectCores())


codestan = '
data {
  int<lower=0> n; //total # of obs
  int<lower=0> k;

  int<lower=0> driver_num[n]; //driver id
  int<lower=0> event_i[n]; //binary outcome
  real<lower=0> drivetime_cum[n]; //cumulative time of driving
  int<lower=0> Age[n]; //precipitation
  int<lower=0> JBI00[n];
  int<lower=0> VAN00[n];
  real<lower=0> visibility[n];
  real<lower=0> precipIntensity[n];
  real<lower=0> precipProbability[n];
}
parameters{
  real beta0[k];
  real beta1[k];
  real b_age;
  real b_JBI;
  real b_VAN;
  real b_visibility;
  real b_prec_inten;
  real b_prec_prob;
  real mu0;
  real mu1;
  real<lower=0> sigma0;
  real<lower=0> sigma1;
}
model{
  for(i in 1:n){
     event_i[i] ~ bernoulli_logit(beta0[driver_num[i]] + beta1[driver_num[i]]*drivetime_cum[i] + b_age*Age[i] + b_JBI*JBI00[i] + b_VAN*VAN00[i] + b_visibility*visibility[i] + b_prec_inten*precipIntensity[i] + b_prec_prob*precipProbability[i]); 
  }
  //PRIORS
  b_age ~ normal(0, 10);
  b_JBI ~ normal(0, 10);
  b_VAN ~ normal(0, 10);
  b_visibility ~ normal(0, 10);
  b_prec_inten ~ normal(0, 10);
  b_prec_prob ~ normal(0, 10);
    for(j in 1:k){
  beta0[j] ~ normal(mu0, sigma0);
  beta1[j] ~ normal(mu1, sigma1);
    }
  //HYPERPRIORS
  mu0 ~ normal(0, 10);
  mu1 ~ normal(0, 10);
  sigma0 ~ gamma(1, 1);
  sigma1 ~ gamma(1, 1);
}
'

datstan = list(n = nrow(w1000),
               k = max(w1000$driver_num),
               driver_num = w1000$driver_num,
               event_i = w1000$event_i,
               drivetime_cum = w1000$drivetime_cum,
               Age = w1000$Age,
               JBI00 = w1000$JBI00,
               VAN00 = w1000$VAN00,
               visibility = w1000$visibility,
               precipIntensity = w1000$precipIntensity,
               precipProbability = w1000$precipProbability)


hfitlogitw1000 <- stan(model_code=codestan, model_name="hospitals1", data=datstan, iter=100,warmup = 50, chains=1, control = list(adapt_delta = 0.9))

#save(hfitlogit20000, file = "hfitlogit20000.Rdata")


#shinystan::launch_shinystan(hfitlogit2w)
```



```{r stanfit for logit model}
## Sample data presentation
# ==============================================
library(stargazer)
library(tidyverse)

options(scipen = 999)

trips_data = w2wdriver %>% 
    slice(c(62:71, 85:92)) %>% 
    select(dispid, driver = driver1, shift, begDate, fromlat, fromLon, EndTime, toLat, toLon, distance, trip_time = travelTime, CT = drivetime_cum, CE = cnum) %>% 
  mutate(dispid = as.integer(as.factor(dispid)), 
         driver = as.integer(as.factor(driver)), 
         shift = ifelse(shift>10, shift-14, shift),
         distance = round(distance, 1),
         trip_time = round(trip_time, 2),
         CT = round(CT, 2),
         begDate = as.character(begDate),
         EndTime = as.character(EndTime))

stargazer::stargazer(trips_data,
                     summary = FALSE,
                     rownames = FALSE,
                     title = "An example data of trips")

weather_data = w2wdriver %>% 
    slice(c(1433:1451)) %>% 
    select(Age, BUSINESS_UNIT, YEARS_OF_EXP, precipIntensity, precipProbability, visibility, sunriseTime, sunsetTime) %>% 
    mutate(sunriseTime = sunriseTime + lubridate::hours(1), 
           sunsetTime = sunsetTime + lubridate::hours(1),
           sunriseTime = as.character(sunriseTime),
           sunsetTime = as.character(sunsetTime))

stargazer::stargazer(weather_data,
                     summary = FALSE,
                     rownames = FALSE,
                     title = "An example data of the driver characteristics and weather variables")

# ==============================================

library(rstan)
library(rstanarm)
library(shinystan)
options(mc.cores=parallel::detectCores())

load("hfitlogit2w.Rdata")

windows(10, 8)

library(gridExtra)
require(grid)
library(latex2exp)

mu0 = traceplot(hfitlogit2w, pars = "mu0") + ylab(TeX("$\\mu_0$"))+ theme(axis.title.y = element_text(angle = 0, face="bold", colour="#990000", size=15))
mu1 = traceplot(hfitlogit2w, pars = "mu1") + ylab(TeX("$\\mu_1$"))+ theme(axis.title.y = element_text(angle = 0, face="bold", colour="#990000", size=15))
sigma0 = traceplot(hfitlogit2w, pars = "sigma0") + ylab(TeX("$\\sigma_0$"))+ theme(axis.title.y = element_text(angle = 0, face="bold", colour="#990000", size=15))
sigma1 = traceplot(hfitlogit2w, pars = "sigma1") + ylab(TeX("$\\sigma_1$"))+ theme(axis.title.y = element_text(angle = 0, face="bold", colour="#990000", size=15))


png("../traceplot.png", units="px", width=4039, height=1743, res = 280)

grid.arrange(mu0, mu1, sigma0, sigma1, ncol=2) #, top = textGrob(latex2exp::TeX("Trace plot for $\\mu_0, \\mu_1, \\sigma_0$, and $\\sigma_1$"), gp=gpar(fontsize=15))

dev.off()




```

```{r rstanarm}
library(rstan)
library(rstanarm)
library(shinystan)
options(mc.cores=parallel::detectCores())

stanglmer_data = w1000 %>% head(200) %>% 
  select(dispid, driver = driver1, shift, begDate, fromlat, fromLon, EndTime, toLat, toLon, distance, trip_time = travelTime, CT = drivetime_cum, CE = cnum, event_i) %>% 
  mutate(dispid = as.integer(as.factor(dispid)), 
         driver = as.integer(as.factor(driver)), 
         distance = round(distance, 1),
         trip_time = round(trip_time, 2),
         CT = round(CT, 2),
         begDate = as.character(begDate),
         EndTime = as.character(EndTime))

armfit = stan_glmer(event_i ~ 1 + CT + (1 + CT|CT), data = stanglmer_data, family = binomial(link = "logit"), chains = 4, iter = 100)
```

```{r}
tot = c(41577, 40419, 171354, 39097)
pos = c(65, 114, 107, 1)

dat = data.frame(x = pos,
                 y = tot - pos)

chisq.test(dat)


fisher.test(as.matrix(dat))
```

